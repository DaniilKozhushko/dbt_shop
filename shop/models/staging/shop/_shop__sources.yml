sources:
  - name: raw
    database: shop_db
    schema: raw
    description: Данные из БД онлайн-магазина

    tables:

      - name: order_items
        description: Детализация заказов (строки чека).
        tests:
          - dbt_utils.unique_combination_of_columns:
              arguments:
                combination_of_columns: ["order_id", "product_id"]
        columns:
          - name: order_id
            description: Ссылка на родительский заказ.
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw', 'orders')
                    field: order_id
          - name: product_id
            description: Ссылка на проданный товар.
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw', 'products')
                    field: product_id
          - name: quantity
            description: Количество единиц товара в строке.
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  arguments:
                    min_value: 0
                    inclusive: false
          - name: price_at_purchase
            description: Зафиксированная цена в момент покупки.
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  arguments:
                    min_value: 0

      - name: orders
        description: Заголовки транзакций (факт совершения заказа и его текущее состояние).
        freshness:
          warn_after: {count: 365, period: day}
          error_after: {count: 700, period: day}
        loaded_at_field: updated_at
        columns:
          - name: order_id
            description: Уникальный номер заказа.
            tests:
              - not_null
              - unique
          - name: user_id
            description: Идентификатор клиента, совершившего покупку.
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw', 'users')
                    field: user_id
          - name: status_id
            description: Ссылка на текущий статус заказа.
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw', 'statuses')
                    field: status_id
          - name: order_date
            description: Дата и время создания заказа.
            tests:
              - not_null
          - name: updated_at
            description: Дата обновления (для инкрементальной загрузки).
            tests:
              - not_null

      - name: users
        description: Профили зарегистрированных клиентов.
        columns:
          - name: user_id
            description: Уникальный идентификатор клиента.
            tests:
              - not_null
              - unique
          - name: first_name
            description: Имя клиента.
            tests:
              - not_null
              - dbt_utils.not_empty_string
          - name: last_name
            description: Фамилия клиента.
          - name: email
            description: Адрес электронной почты клиента.
            tests:
              - not_null
              - unique
              - dbt_utils.not_empty_string
              - dbt_utils.expression_is_true:
                  arguments:
                    expression: "~* '^[a-z]+[0-9]+@[a-z]+\\.(com|ru|kz)$'"
          - name: address
            description: Текущий почтовый адрес клиента.
            tests:
              - not_null
              - dbt_utils.not_empty_string
          - name: updated_at
            description: Дата обновления (для инкрементальной загрузки).
            tests:
              - not_null
          - name: is_deleted
            description: Удалён ли аккаунт клиента.
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: [true, false]
                    quote: false

      - name: products
        description: Актуальный каталог товаров магазина с текущими ценами.
        columns:
          - name: product_id
            description: Уникальный идентификатор товара (SKU).
            tests:
              - not_null
              - unique
          - name: name
            description: Коммерческое наименование товара.
            tests:
              - not_null
              - dbt_utils.not_empty_string
          - name: category_id
            description: Ссылка на категорию товара.
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw', 'categories')
                    field: category_id
          - name: uom_id
            description: Ссылка на единицу измерения.
            tests:
              - not_null
              - relationships:
                  arguments:
                    to: source('raw', 'units_of_measure')
                    field: uom_id
          - name: price
            description: Текущая розничная цена в магазине.
            tests:
              - not_null
              - dbt_utils.accepted_range:
                  arguments:
                    min_value: 0
                    inclusive: false
          - name: is_active
            description: Продаётся ли товар в настоящее время.
            tests:
              - not_null
              - accepted_values:
                  arguments:
                    values: [true, false]
          - name: updated_at
            description: Дата обновления (для инкрементальной загрузки).
            tests:
              - not_null

      - name: categories
        description: Категории товаров.
        columns:
          - name: category_id
            description: Уникальный идентификатор категории.
            tests:
              - not_null
              - unique
          - name: name
            description: Наименование категории.
            tests:
              - not_null
              - unique
              - dbt_utils.not_empty_string

      - name: statuses
        description: Статусы товаров.
        columns:
          - name: status_id
            description: Уникальный идентификатор статуса.
            tests:
              - not_null
              - unique
          - name: name
            description: Наименование статуса.
            tests:
              - not_null
              - unique
              - dbt_utils.not_empty_string
              
      - name: units_of_measure
        description: Единицы измерения товаров.
        columns:
          - name: uom_id
            description: Уникальный идентификатор статуса.
            tests:
              - not_null
              - unique
          - name: name
            description: Наименование единицы измерения.
            tests:
              - not_null
              - unique
              - dbt_utils.not_empty_string
          - name: short_name
            description: Сокращённое наименование единицы измерения.
            tests:
              - not_null
              - unique
              - dbt_utils.not_empty_string